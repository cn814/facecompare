<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Comparison Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .loading {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .loading-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .upload-box h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .upload-box p {
            color: #666;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: #4caf50;
            padding: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .preview-container {
            position: relative;
            max-width: 100%;
        }

        .preview-image,
        .preview-container canvas {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
        }

        .face-box {
            position: absolute;
            border: 3px solid #4caf50;
            border-radius: 5px;
            pointer-events: none;
        }

        .face-label {
            position: absolute;
            background: #4caf50;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .compare-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .compare-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.6);
        }

        .compare-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .result-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
        }

        .result-item.match {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .result-item.no-match {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .similarity-score {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .similarity-score.match {
            color: #4caf50;
        }

        .similarity-score.no-match {
            color: #f44336;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-fill.match {
            background: linear-gradient(90deg, #4caf50, #45a049);
        }

        .progress-fill.no-match {
            background: linear-gradient(90deg, #f44336, #da190b);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 5px solid #f44336;
        }

        .info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 5px solid #2196f3;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Face Comparison Tool</h1>
        <p class="subtitle">Compare faces to see if they're the same person ‚Ä¢ 100% private, runs in your browser</p>

        <div id="loadingStatus" class="loading">
            <h3>Loading AI Models...</h3>
            <p id="loadingText">Preparing face detection models</p>
            <div class="loading-bar">
                <div id="loadingProgress" class="loading-progress"></div>
            </div>
        </div>

        <div id="mainApp" class="hidden">
            <div class="upload-section">
                <div class="upload-box">
                    <h2>Reference Photo</h2>
                    <p>Upload the photo you want to compare against</p>
                    <div class="upload-area" id="uploadArea1" onclick="document.getElementById('fileInput1').click()">
                        <div id="uploadPrompt1">
                            <div class="upload-icon">üì∏</div>
                            <p><strong>Click to upload</strong> or drag and drop</p>
                            <p style="font-size: 0.9em; color: #999;">JPG, PNG, GIF, or WebP</p>
                            <p style="font-size: 0.8em; color: #ff9800; margin-top: 5px;">‚ö†Ô∏è Motion Photos/Live Photos not supported</p>
                        </div>
                        <div id="preview1" class="preview-container hidden"></div>
                    </div>
                    <input type="file" id="fileInput1" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                </div>

                <div class="upload-box">
                    <h2>Comparison Photo(s)</h2>
                    <p>Upload one or more photos to compare</p>
                    <div class="upload-area" id="uploadArea2" onclick="document.getElementById('fileInput2').click()">
                        <div id="uploadPrompt2">
                            <div class="upload-icon">üì∑</div>
                            <p><strong>Click to upload</strong> or drag and drop</p>
                            <p style="font-size: 0.9em; color: #999;">JPG, PNG, GIF, or WebP ‚Ä¢ Multiple files OK</p>
                            <p style="font-size: 0.8em; color: #ff9800; margin-top: 5px;">‚ö†Ô∏è Motion Photos/Live Photos not supported</p>
                        </div>
                        <div id="preview2" class="preview-container hidden"></div>
                    </div>
                    <input type="file" id="fileInput2" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" multiple>
                </div>
            </div>

            <button id="compareBtn" class="compare-btn" disabled>Upload Photos to Compare</button>

            <div id="results" class="results hidden"></div>
        </div>
    </div>

    <script>
        let modelsLoaded = false;
        let referenceDescriptor = null;
        let referenceFaces = [];
        let selectedReferenceIndex = 0;
        let referenceImage = null;
        let comparisonImages = [];

        // Load models
        async function loadModels() {
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
                
                loadingText.textContent = 'Loading face detection models...';
                loadingProgress.style.width = '20%';
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                
                loadingText.textContent = 'Loading accurate detection model...';
                loadingProgress.style.width = '40%';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                
                loadingText.textContent = 'Loading face landmark model...';
                loadingProgress.style.width = '60%';
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                
                loadingText.textContent = 'Loading face recognition model...';
                loadingProgress.style.width = '80%';
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                
                loadingProgress.style.width = '100%';
                loadingText.textContent = 'Ready!';
                
                setTimeout(() => {
                    document.getElementById('loadingStatus').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    modelsLoaded = true;
                }, 500);
            } catch (error) {
                loadingText.innerHTML = `<span style="color: red;">Error loading models: ${error.message}</span><br>Please refresh the page to try again.`;
            }
        }

        // File input handlers - will be set up in initialize()
        function setupEventListeners() {
            document.getElementById('fileInput1').addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    try {
                        await handleReferenceImage(e.target.files[0]);
                    } catch (error) {
                        console.error('Error handling reference image:', error);
                        const preview = document.getElementById('preview1');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error';
                        errorDiv.innerHTML = `
                            <strong>Error:</strong> ${error.message}<br><br>
                            <strong>Troubleshooting tips:</strong><br>
                            ‚Ä¢ Try a different photo<br>
                            ‚Ä¢ Use standard formats: JPG, PNG, GIF, WebP<br>
                            ‚Ä¢ If using a Motion Photo or Live Photo, export as a regular JPG first<br>
                            ‚Ä¢ Try reducing the file size if it's very large
                        `;
                        preview.appendChild(errorDiv);
                    }
                }
            });

            document.getElementById('fileInput2').addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    try {
                        await handleComparisonImages(Array.from(e.target.files));
                    } catch (error) {
                        console.error('Error handling comparison images:', error);
                        const preview = document.getElementById('preview2');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error';
                        errorDiv.innerHTML = `
                            <strong>Error:</strong> ${error.message}<br><br>
                            <strong>Troubleshooting tips:</strong><br>
                            ‚Ä¢ Try different photos<br>
                            ‚Ä¢ Use standard formats: JPG, PNG, GIF, WebP<br>
                            ‚Ä¢ If using Motion Photos or Live Photos, export as regular JPGs first<br>
                            ‚Ä¢ Try reducing file sizes if they're very large
                        `;
                        preview.appendChild(errorDiv);
                    }
                }
            });
        }

        async function handleReferenceImage(file) {
            console.log('Processing reference image:', file.name);
            const preview = document.getElementById('preview1');
            const uploadPrompt = document.getElementById('uploadPrompt1');
            const uploadArea = document.getElementById('uploadArea1');
            
            const img = await loadImage(file);
            referenceImage = img;
            
            uploadPrompt.classList.add('hidden');
            preview.classList.remove('hidden');
            preview.innerHTML = '';
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Scale down for display while keeping aspect ratio
            const maxDisplayWidth = 600;
            const maxDisplayHeight = 400;
            let displayWidth = img.width;
            let displayHeight = img.height;
            
            if (img.width > maxDisplayWidth || img.height > maxDisplayHeight) {
                const widthRatio = maxDisplayWidth / img.width;
                const heightRatio = maxDisplayHeight / img.height;
                const scale = Math.min(widthRatio, heightRatio);
                displayWidth = img.width * scale;
                displayHeight = img.height * scale;
            }
            
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            ctx.drawImage(img, 0, 0, displayWidth, displayHeight);
            
            preview.appendChild(canvas);
            uploadArea.classList.add('has-image');
            
            // Detect ALL faces (using original image for accuracy)
            // Try TinyFaceDetector first (more accurate), fall back to SSD if no faces found
            console.log('Detecting faces in reference image with TinyFaceDetector...');
            let detections = await faceapi
                .detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ 
                    inputSize: 416,
                    scoreThreshold: 0.3  // Lower threshold for more lenient detection
                }))
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            // Fallback to SSD MobileNet if TinyFaceDetector found nothing
            if (detections.length === 0) {
                console.log('No faces found with TinyFaceDetector, trying SSD MobileNet...');
                detections = await faceapi
                    .detectAllFaces(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.3 }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();
            }
            
            console.log('Detected', detections.length, 'face(s) in reference image');
            
            if (detections.length > 0) {
                referenceFaces = detections;
                selectedReferenceIndex = 0;
                referenceDescriptor = detections[0].descriptor;
                
                // Detect sunglasses in reference faces
                detections.forEach((detection, index) => {
                    detection.hasSunglasses = detectSunglasses(img, detection.landmarks);
                });
                
                // Calculate scale factor for drawing boxes and landmarks
                const scaleX = displayWidth / img.width;
                const scaleY = displayHeight / img.height;
                
                // Draw facial landmarks for all detected faces
                detections.forEach((detection) => {
                    drawLandmarks(canvas, detection.landmarks, scaleX, scaleY);
                });
                
                // Draw all face boxes
                detections.forEach((detection, index) => {
                    const box = detection.detection.box;
                    const faceBox = document.createElement('div');
                    faceBox.className = 'face-box';
                    faceBox.style.left = (box.x * scaleX) + 'px';
                    faceBox.style.top = (box.y * scaleY) + 'px';
                    faceBox.style.width = (box.width * scaleX) + 'px';
                    faceBox.style.height = (box.height * scaleY) + 'px';
                    faceBox.style.cursor = 'pointer';
                    faceBox.style.borderColor = index === 0 ? '#4caf50' : '#ff9800';
                    faceBox.dataset.index = index;
                    
                    // Calculate center of face using landmarks for better positioning
                    const landmarks = detection.landmarks.positions;
                    let centerX = 0, centerY = 0;
                    landmarks.forEach(point => {
                        centerX += point.x;
                        centerY += point.y;
                    });
                    centerX = (centerX / landmarks.length) * scaleX;
                    centerY = (centerY / landmarks.length) * scaleY;
                    
                    const label = document.createElement('div');
                    label.className = 'face-label';
                    label.style.backgroundColor = index === 0 ? '#4caf50' : '#ff9800';
                    label.textContent = index === 0 ? `Face ${index + 1} (Selected)` : `Face ${index + 1} - Click to select`;
                    // Position label at center of face instead of top-left of box
                    label.style.position = 'absolute';
                    label.style.left = (centerX - (box.x * scaleX)) + 'px';
                    label.style.top = (centerY - (box.y * scaleY) - 12) + 'px';
                    label.style.transform = 'translateX(-50%)';
                    faceBox.appendChild(label);
                    
                    // Click to select this face as reference
                    faceBox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectReferenceFace(index);
                    });
                    
                    preview.appendChild(faceBox);
                    
                    // Add sunglasses warning if detected
                    if (detection.hasSunglasses) {
                        const sunglassesWarning = document.createElement('div');
                        sunglassesWarning.style.position = 'absolute';
                        sunglassesWarning.style.left = (box.x * scaleX) + 'px';
                        sunglassesWarning.style.top = (box.y * scaleY + box.height * scaleY + 5) + 'px';
                        sunglassesWarning.style.background = '#ff9800';
                        sunglassesWarning.style.color = 'white';
                        sunglassesWarning.style.padding = '3px 8px';
                        sunglassesWarning.style.borderRadius = '3px';
                        sunglassesWarning.style.fontSize = '11px';
                        sunglassesWarning.style.fontWeight = 'bold';
                        sunglassesWarning.textContent = '‚ö†Ô∏è Sunglasses detected';
                        preview.appendChild(sunglassesWarning);
                    }
                });
                
                if (detections.length > 1) {
                    const info = document.createElement('div');
                    info.className = 'info';
                    info.style.marginTop = '10px';
                    info.innerHTML = `<strong>${detections.length} faces detected!</strong> Click on a face to select it as the reference.`;
                    preview.appendChild(info);
                }
                
                // Add landmark legend
                const legend = document.createElement('div');
                legend.style.marginTop = '10px';
                legend.style.fontSize = '0.85em';
                legend.style.color = '#666';
                legend.style.padding = '10px';
                legend.style.background = '#f8f9fa';
                legend.style.borderRadius = '5px';
                legend.innerHTML = `
                    <strong>Facial Landmarks:</strong> 
                    <span style="color: #FF6B6B;">‚óè Jawline</span> ‚Ä¢ 
                    <span style="color: #4ECDC4;">‚óè Eyebrows</span> ‚Ä¢ 
                    <span style="color: #45B7D1;">‚óè Nose</span> ‚Ä¢ 
                    <span style="color: #FFA07A;">‚óè Eyes</span> ‚Ä¢ 
                    <span style="color: #98D8C8;">‚óè Mouth</span>
                `;
                preview.appendChild(legend);
                
                checkReadyToCompare();
            } else {
                showError(preview, 'No faces detected in this image. Please try another photo.');
                referenceFaces = [];
                referenceDescriptor = null;
            }
        }

        function selectReferenceFace(index) {
            selectedReferenceIndex = index;
            referenceDescriptor = referenceFaces[index].descriptor;
            
            const preview = document.getElementById('preview1');
            const faceBoxes = preview.querySelectorAll('.face-box');
            
            faceBoxes.forEach((box, i) => {
                const isSelected = i === index;
                box.style.borderColor = isSelected ? '#4caf50' : '#ff9800';
                const label = box.querySelector('.face-label');
                label.style.backgroundColor = isSelected ? '#4caf50' : '#ff9800';
                label.textContent = isSelected ? `Face ${i + 1} (Selected)` : `Face ${i + 1} - Click to select`;
            });
        }

        function drawLandmarks(canvas, landmarks, scaleX = 1, scaleY = 1) {
            const ctx = canvas.getContext('2d');
            
            // Draw all 68 landmark points
            landmarks.positions.forEach((point, index) => {
                ctx.beginPath();
                ctx.arc(point.x * scaleX, point.y * scaleY, 2, 0, 2 * Math.PI);
                
                // Color code different facial features
                if (index < 17) {
                    // Jaw line
                    ctx.fillStyle = '#FF6B6B';
                } else if (index < 27) {
                    // Eyebrows
                    ctx.fillStyle = '#4ECDC4';
                } else if (index < 36) {
                    // Nose
                    ctx.fillStyle = '#45B7D1';
                } else if (index < 48) {
                    // Eyes
                    ctx.fillStyle = '#FFA07A';
                } else {
                    // Mouth
                    ctx.fillStyle = '#98D8C8';
                }
                
                ctx.fill();
                
                // Add white outline for visibility
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        function detectSunglasses(image, landmarks) {
            // Create a temporary canvas to analyze the eye region
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);
            
            // Eye landmarks: 36-41 (left eye), 42-47 (right eye)
            const leftEyeLandmarks = landmarks.positions.slice(36, 42);
            const rightEyeLandmarks = landmarks.positions.slice(42, 48);
            
            // Calculate bounding boxes for eyes
            const getEyeBox = (eyeLandmarks) => {
                const xs = eyeLandmarks.map(p => p.x);
                const ys = eyeLandmarks.map(p => p.y);
                return {
                    x: Math.min(...xs),
                    y: Math.min(...ys),
                    width: Math.max(...xs) - Math.min(...xs),
                    height: Math.max(...ys) - Math.min(...ys)
                };
            };
            
            const leftEyeBox = getEyeBox(leftEyeLandmarks);
            const rightEyeBox = getEyeBox(rightEyeLandmarks);
            
            // Expand boxes slightly to include sunglasses frames
            const expandBox = (box, factor = 1.3) => ({
                x: box.x - (box.width * (factor - 1) / 2),
                y: box.y - (box.height * (factor - 1) / 2),
                width: box.width * factor,
                height: box.height * factor
            });
            
            const leftExpanded = expandBox(leftEyeBox);
            const rightExpanded = expandBox(rightEyeBox);
            
            // Sample pixels from eye regions
            const sampleRegion = (box) => {
                const imageData = ctx.getImageData(box.x, box.y, box.width, box.height);
                const pixels = imageData.data;
                let totalBrightness = 0;
                let darkPixels = 0;
                const pixelCount = pixels.length / 4;
                
                for (let i = 0; i < pixels.length; i += 4) {
                    const r = pixels[i];
                    const g = pixels[i + 1];
                    const b = pixels[i + 2];
                    const brightness = (r + g + b) / 3;
                    totalBrightness += brightness;
                    
                    // Count very dark pixels (likely sunglasses)
                    if (brightness < 60) {
                        darkPixels++;
                    }
                }
                
                const avgBrightness = totalBrightness / pixelCount;
                const darkRatio = darkPixels / pixelCount;
                
                return { avgBrightness, darkRatio };
            };
            
            const leftEyeData = sampleRegion(leftExpanded);
            const rightEyeData = sampleRegion(rightExpanded);
            
            // Check for sunglasses indicators:
            // 1. Both eyes are very dark
            // 2. High percentage of dark pixels
            // 3. Similar darkness in both eyes (sunglasses tend to be uniform)
            
            const avgBrightness = (leftEyeData.avgBrightness + rightEyeData.avgBrightness) / 2;
            const avgDarkRatio = (leftEyeData.darkRatio + rightEyeData.darkRatio) / 2;
            const brightnessSimilarity = Math.abs(leftEyeData.avgBrightness - rightEyeData.avgBrightness);
            
            // Sunglasses indicators - made much stricter to reduce false positives
            const veryDark = avgBrightness < 50;  // Changed from 80 to 50 (much darker required)
            const highDarkRatio = avgDarkRatio > 0.6;  // Changed from 0.4 to 0.6 (more dark pixels required)
            const uniformAcrossEyes = brightnessSimilarity < 15;  // Changed from 20 to 15 (more uniform required)
            
            // Require ALL THREE conditions for sunglasses detection (was using OR)
            const hasSunglasses = veryDark && highDarkRatio && uniformAcrossEyes;
            
            console.log('Sunglasses detection:', {
                avgBrightness,
                avgDarkRatio,
                brightnessSimilarity,
                veryDark,
                highDarkRatio,
                uniformAcrossEyes,
                hasSunglasses
            });
            
            return hasSunglasses;
        }

        async function handleComparisonImages(files) {
            console.log('Processing', files.length, 'comparison image(s)');
            const preview = document.getElementById('preview2');
            const uploadPrompt = document.getElementById('uploadPrompt2');
            const uploadArea = document.getElementById('uploadArea2');
            
            uploadPrompt.classList.add('hidden');
            preview.classList.remove('hidden');
            preview.innerHTML = '';
            uploadArea.classList.add('has-image');
            
            comparisonImages = [];
            
            for (const file of files) {
                const img = await loadImage(file);
                const container = document.createElement('div');
                container.style.marginBottom = '20px';
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Scale down for display
                const maxDisplayWidth = 500;
                const maxDisplayHeight = 400;
                let displayWidth = img.width;
                let displayHeight = img.height;
                
                if (img.width > maxDisplayWidth || img.height > maxDisplayHeight) {
                    const widthRatio = maxDisplayWidth / img.width;
                    const heightRatio = maxDisplayHeight / img.height;
                    const scale = Math.min(widthRatio, heightRatio);
                    displayWidth = img.width * scale;
                    displayHeight = img.height * scale;
                }
                
                canvas.width = displayWidth;
                canvas.height = displayHeight;
                ctx.drawImage(img, 0, 0, displayWidth, displayHeight);
                
                // Detect ALL faces (using original image)
                // Try TinyFaceDetector first, fall back to SSD if needed
                console.log('Detecting faces in:', file.name, 'with TinyFaceDetector...');
                let detections = await faceapi
                    .detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ 
                        inputSize: 416,
                        scoreThreshold: 0.3
                    }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                if (detections.length === 0) {
                    console.log('No faces found with TinyFaceDetector, trying SSD MobileNet...');
                    detections = await faceapi
                        .detectAllFaces(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.3 }))
                        .withFaceLandmarks()
                        .withFaceDescriptors();
                }
                
                console.log('Detected', detections.length, 'face(s) in', file.name);
                
                if (detections.length > 0) {
                    // Detect sunglasses in all faces
                    detections.forEach((detection) => {
                        detection.hasSunglasses = detectSunglasses(img, detection.landmarks);
                    });
                    
                    comparisonImages.push({
                        file: file,
                        image: img,
                        faces: detections
                    });
                    
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'inline-block';
                    wrapper.appendChild(canvas);
                    
                    // Calculate scale factor for drawing boxes and landmarks
                    const scaleX = displayWidth / img.width;
                    const scaleY = displayHeight / img.height;
                    
                    // Draw facial landmarks for all detected faces
                    detections.forEach((detection) => {
                        drawLandmarks(canvas, detection.landmarks, scaleX, scaleY);
                    });
                    
                    // Draw all face boxes
                    detections.forEach((detection, faceIndex) => {
                        const box = detection.detection.box;
                        const faceBox = document.createElement('div');
                        faceBox.className = 'face-box';
                        faceBox.style.left = (box.x * scaleX) + 'px';
                        faceBox.style.top = (box.y * scaleY) + 'px';
                        faceBox.style.width = (box.width * scaleX) + 'px';
                        faceBox.style.height = (box.height * scaleY) + 'px';
                        
                        // Calculate center of face using landmarks
                        const landmarks = detection.landmarks.positions;
                        let centerX = 0, centerY = 0;
                        landmarks.forEach(point => {
                            centerX += point.x;
                            centerY += point.y;
                        });
                        centerX = (centerX / landmarks.length) * scaleX;
                        centerY = (centerY / landmarks.length) * scaleY;
                        
                        const label = document.createElement('div');
                        label.className = 'face-label';
                        label.textContent = `${faceIndex + 1}`;
                        // Position label at center of face
                        label.style.position = 'absolute';
                        label.style.left = (centerX - (box.x * scaleX)) + 'px';
                        label.style.top = (centerY - (box.y * scaleY) - 12) + 'px';
                        label.style.transform = 'translateX(-50%)';
                        faceBox.appendChild(label);
                        
                        wrapper.appendChild(faceBox);
                        
                        // Add sunglasses warning if detected
                        if (detection.hasSunglasses) {
                            const sunglassesWarning = document.createElement('div');
                            sunglassesWarning.style.position = 'absolute';
                            sunglassesWarning.style.left = (box.x * scaleX) + 'px';
                            sunglassesWarning.style.top = (box.y * scaleY + box.height * scaleY + 5) + 'px';
                            sunglassesWarning.style.background = '#ff9800';
                            sunglassesWarning.style.color = 'white';
                            sunglassesWarning.style.padding = '3px 8px';
                            sunglassesWarning.style.borderRadius = '3px';
                            sunglassesWarning.style.fontSize = '11px';
                            sunglassesWarning.style.fontWeight = 'bold';
                            sunglassesWarning.textContent = '‚ö†Ô∏è Sunglasses';
                            wrapper.appendChild(sunglassesWarning);
                        }
                    });
                    
                    container.appendChild(wrapper);
                    
                    if (detections.length > 1) {
                        const faceCount = document.createElement('div');
                        faceCount.style.marginTop = '5px';
                        faceCount.style.fontSize = '0.9em';
                        faceCount.style.color = '#666';
                        faceCount.innerHTML = `<strong>${detections.length} faces detected</strong>`;
                        container.appendChild(faceCount);
                    }
                } else {
                    container.appendChild(canvas);
                    const error = document.createElement('div');
                    error.className = 'error';
                    error.textContent = `No faces detected in ${file.name}`;
                    container.appendChild(error);
                }
                
                preview.appendChild(container);
            }
            
            // Add landmark legend if any faces were detected
            if (comparisonImages.length > 0) {
                const legend = document.createElement('div');
                legend.style.marginTop = '15px';
                legend.style.fontSize = '0.85em';
                legend.style.color = '#666';
                legend.style.padding = '10px';
                legend.style.background = '#f8f9fa';
                legend.style.borderRadius = '5px';
                legend.innerHTML = `
                    <strong>Facial Landmarks:</strong> 
                    <span style="color: #FF6B6B;">‚óè Jawline</span> ‚Ä¢ 
                    <span style="color: #4ECDC4;">‚óè Eyebrows</span> ‚Ä¢ 
                    <span style="color: #45B7D1;">‚óè Nose</span> ‚Ä¢ 
                    <span style="color: #FFA07A;">‚óè Eyes</span> ‚Ä¢ 
                    <span style="color: #98D8C8;">‚óè Mouth</span>
                `;
                preview.appendChild(legend);
            }
            
            checkReadyToCompare();
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                console.log('Loading image file:', file.name, 'Type:', file.type, 'Size:', file.size, 'bytes');
                
                // Check if it's an image file
                if (!file.type.startsWith('image/')) {
                    reject(new Error(`File type not supported: ${file.type}. Please use JPG, PNG, or other standard image formats.`));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        console.log('‚úì Image loaded successfully:', file.name, 'Dimensions:', img.width, 'x', img.height);
                        resolve(img);
                    };
                    
                    img.onerror = (err) => {
                        console.error('‚úó Image decode error for:', file.name, err);
                        reject(new Error(`Failed to decode image: ${file.name}. The file may be corrupted.`));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = (err) => {
                    console.error('‚úó FileReader error:', err);
                    reject(new Error(`Failed to read file: ${file.name}`));
                };
                
                reader.readAsDataURL(file);
            });
        }

        function checkReadyToCompare() {
            const btn = document.getElementById('compareBtn');
            if (referenceDescriptor && comparisonImages.length > 0) {
                btn.disabled = false;
                const totalFaces = comparisonImages.reduce((sum, img) => sum + img.faces.length, 0);
                btn.textContent = `Compare Against ${totalFaces} Face${totalFaces > 1 ? 's' : ''}`;
            } else {
                btn.disabled = true;
                btn.textContent = 'Upload Photos to Compare';
            }
        }

        document.getElementById('compareBtn').addEventListener('click', performComparison);

        function performComparison() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = '<h2>üìä Comparison Results</h2>';
            
            let matchCount = 0;
            let totalFaces = 0;
            
            // Collect all face comparisons with their scores
            const allComparisons = [];
            
            comparisonImages.forEach((comp, imgIndex) => {
                comp.faces.forEach((face, faceIndex) => {
                    totalFaces++;
                    const distance = faceapi.euclideanDistance(referenceDescriptor, face.descriptor);
                    
                    // Check if either reference or comparison face has sunglasses
                    const referenceSunglasses = referenceFaces[selectedReferenceIndex].hasSunglasses;
                    const comparisonSunglasses = face.hasSunglasses;
                    const anySunglasses = referenceSunglasses || comparisonSunglasses;
                    
                    // Adjust thresholds if sunglasses detected (be more lenient)
                    const thresholdAdjustment = anySunglasses ? 0.1 : 0;
                    
                    // More sophisticated scoring with sunglasses adjustment
                    let similarity, confidence, isMatch;
                    if (distance < (0.4 + thresholdAdjustment)) {
                        similarity = 95 + ((0.4 + thresholdAdjustment) - distance) * 12.5;  // 95-100%
                        confidence = anySunglasses ? "High (sunglasses)" : "Very High";
                        isMatch = true;
                    } else if (distance < (0.5 + thresholdAdjustment)) {
                        similarity = 85 + ((0.5 + thresholdAdjustment) - distance) * 100;  // 85-95%
                        confidence = anySunglasses ? "Good (sunglasses)" : "High";
                        isMatch = true;
                    } else if (distance < (0.6 + thresholdAdjustment)) {
                        similarity = 70 + ((0.6 + thresholdAdjustment) - distance) * 150;  // 70-85%
                        confidence = anySunglasses ? "Moderate (sunglasses)" : "Good";
                        isMatch = true;
                    } else if (distance < (0.7 + thresholdAdjustment)) {
                        similarity = 50 + ((0.7 + thresholdAdjustment) - distance) * 200;  // 50-70%
                        confidence = anySunglasses ? "Low (sunglasses)" : "Moderate";
                        isMatch = false;
                    } else {
                        similarity = Math.max(0, 50 - (distance - (0.7 + thresholdAdjustment)) * 100);  // 0-50%
                        confidence = "Low";
                        isMatch = false;
                    }
                    
                    similarity = Math.min(100, Math.max(0, similarity));
                    
                    if (isMatch) matchCount++;
                    
                    allComparisons.push({
                        fileName: comp.file.name,
                        faceIndex: faceIndex,
                        similarity: similarity,
                        confidence: confidence,
                        isMatch: isMatch,
                        distance: distance,
                        hasSunglasses: comparisonSunglasses,
                        referenceSunglasses: referenceSunglasses
                    });
                });
            });
            
            // Sort by similarity (highest first)
            allComparisons.sort((a, b) => b.similarity - a.similarity);
            
            // Display sorted results
            allComparisons.forEach((comp, index) => {
                let verdictText, verdictIcon;
                if (comp.similarity >= 85) {
                    verdictText = "Very likely the same person";
                    verdictIcon = "‚úÖ";
                } else if (comp.similarity >= 70) {
                    verdictText = "Likely the same person";
                    verdictIcon = "‚úÖ";
                } else if (comp.similarity >= 50) {
                    verdictText = "Possibly the same person";
                    verdictIcon = "‚ö†Ô∏è";
                } else {
                    verdictText = "Likely different people";
                    verdictIcon = "‚ùå";
                }
                
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${comp.isMatch ? 'match' : 'no-match'}`;
                
                // Add rank badge
                let rankBadge = '';
                if (index === 0 && comp.similarity >= 70) {
                    rankBadge = ' <span style="background: gold; color: #333; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; font-weight: bold;">üèÜ BEST MATCH</span>';
                }
                
                // Add sunglasses warning if detected
                let sunglassesNote = '';
                if (comp.referenceSunglasses && comp.hasSunglasses) {
                    sunglassesNote = '<div style="background: #fff3cd; border-left: 3px solid #ff9800; padding: 8px; margin: 10px 0; border-radius: 3px; font-size: 0.9em;">‚ö†Ô∏è <strong>Both faces have sunglasses</strong> - Accuracy may be reduced. Thresholds adjusted to be more lenient.</div>';
                } else if (comp.referenceSunglasses || comp.hasSunglasses) {
                    sunglassesNote = '<div style="background: #fff3cd; border-left: 3px solid #ff9800; padding: 8px; margin: 10px 0; border-radius: 3px; font-size: 0.9em;">‚ö†Ô∏è <strong>Sunglasses detected</strong> - Accuracy may be reduced. Thresholds adjusted to be more lenient.</div>';
                }
                
                resultItem.innerHTML = `
                    <h4 style="margin-bottom: 10px;">
                        #${index + 1}: ${comp.fileName} - Face ${comp.faceIndex + 1}${rankBadge}
                    </h4>
                    ${sunglassesNote}
                    <div class="similarity-score ${comp.isMatch ? 'match' : 'no-match'}">${comp.similarity.toFixed(1)}% Match</div>
                    <div style="margin: 5px 0; color: #666;">Confidence: <strong>${comp.confidence}</strong></div>
                    <div class="progress-bar">
                        <div class="progress-fill ${comp.isMatch ? 'match' : 'no-match'}" style="width: ${comp.similarity}%">
                            ${comp.similarity.toFixed(1)}%
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666;">
                        <strong>Verdict:</strong> ${verdictIcon} ${verdictText}
                    </p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #999;">
                        Euclidean distance: ${comp.distance.toFixed(3)} (lower = more similar)
                    </p>
                `;
                
                resultsDiv.appendChild(resultItem);
            });
            
            // Summary
            const summary = document.createElement('div');
            summary.className = 'result-item';
            summary.style.background = '#f0f7ff';
            summary.style.borderLeftColor = '#2196f3';
            summary.innerHTML = `
                <h3>Summary</h3>
                <p style="font-size: 1.1em; margin-top: 10px;">
                    Found <strong>${matchCount} likely match${matchCount !== 1 ? 'es' : ''}</strong> out of <strong>${totalFaces} face${totalFaces !== 1 ? 's' : ''}</strong> analyzed.
                </p>
                <p style="margin-top: 10px; color: #666;">
                    Results are sorted by match percentage (highest first).
                </p>
            `;
            resultsDiv.appendChild(summary);
            
            // Info box
            const info = document.createElement('div');
            info.className = 'info';
            info.innerHTML = `
                <strong>Understanding the results:</strong><br>
                <strong>Score Ranges:</strong><br>
                ‚Ä¢ 85-100% = Very likely the same person (Very High Confidence)<br>
                ‚Ä¢ 70-84% = Likely the same person (Good-High Confidence)<br>
                ‚Ä¢ 50-69% = Possibly the same person (Moderate Confidence)<br>
                ‚Ä¢ Below 50% = Likely different people (Low Confidence)<br><br>
                <strong>What affects accuracy:</strong><br>
                ‚Ä¢ Photo angle and lighting<br>
                ‚Ä¢ Facial expression and age difference<br>
                ‚Ä¢ Image quality and resolution<br>
                ‚Ä¢ Accessories (glasses, hats, makeup)<br><br>
                <strong>Sunglasses Detection:</strong><br>
                ‚Ä¢ When sunglasses are detected, matching thresholds are automatically adjusted to be more lenient (+10%)<br>
                ‚Ä¢ This compensates for reduced eye region visibility<br>
                ‚Ä¢ For best results, use photos without sunglasses when possible<br><br>
                <strong>Detection:</strong> This tool uses dual AI models (TinyFaceDetector + SSD MobileNet) for maximum reliability.<br>
                ${referenceFaces.length > 1 ? '<br><strong>Tip:</strong> Multiple faces detected in reference photo. Click on different faces to compare against different people!' : ''}
            `;
            resultsDiv.appendChild(info);
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showError(element, message) {
            const error = document.createElement('div');
            error.className = 'error';
            error.textContent = message;
            element.appendChild(error);
        }

        // Initialize - wait for both DOM and faceapi to be ready
        function initialize() {
            if (typeof faceapi === 'undefined') {
                console.log('Waiting for face-api.js to load...');
                setTimeout(initialize, 100);
                return;
            }
            console.log('Initializing face comparison tool...');
            setupEventListeners();
            loadModels();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
